# AgentDNS Backend

![AgentDNS Logo](https://img.shields.io/badge/AgentDNS-v0.1.0-blue.svg)

## 📋 Overview

**AgentDNS** is a root-domain naming and service discovery system designed for LLM Agents. It provides a complete solution for service registration, discovery, proxying, and management to help AI Agents find and consume services easily.

### ✨ Key Features

- 🔍 **Semantic Discovery** - Vector-based semantic search for services
- 🛡️ **Secure Proxy** - Built-in auth and API key management
- 📊 **Usage Analytics** - Detailed usage and billing
- 🏢 **Organization Management** - Multi-tenant, team collaboration
- 🔌 **Multi-Protocol** - HTTPS, MCP, A2A, etc.
- 📈 **Monitoring & Alerts** - Real-time service status

### 🏗️ Architecture

```
![AgentDNS Architecture](/AgentDNS/agentdns-backend/images/arch.png)
```

## 🚀 Getting Started

### 📋 System Requirements

- **Python**: 3.8+
- **PostgreSQL**: 13+
- **Redis**: 6.0+
- **Milvus**: 2.3.x (vector database)
- **OS**: Ubuntu 18.04+ / CentOS 7+ / Debian 10+

### 🔧 Environment Setup

#### 1. Python Environment

```bash
# Check Python version
python3 --version  # should be >= 3.8

# Create virtual environment
python3 -m venv venv

# Activate virtual environment
source venv/bin/activate
```

#### 2. Install Databases

##### PostgreSQL

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

**CentOS/RHEL:**
```bash
sudo yum install postgresql-server postgresql-contrib
sudo postgresql-setup initdb
sudo systemctl enable postgresql
sudo systemctl start postgresql
```

##### Redis

**Ubuntu/Debian:**
```bash
sudo apt install redis-server
sudo systemctl start redis
sudo systemctl enable redis
```

**CentOS/RHEL:**
```bash
sudo yum install redis
sudo systemctl enable redis
sudo systemctl start redis
```

##### Milvus

**With Docker (recommended):**
```bash
# Download docker-compose file
wget https://github.com/milvus-io/milvus/releases/download/v2.3.4/milvus-standalone-docker-compose.yml -O docker-compose.yml

# Start Milvus
docker-compose up -d
```

**Or Milvus Lite:**
```bash
pip install milvus-lite
```

### 📦 Project Installation

#### 1. Clone

```bash
git clone <repository-url>
cd agentdns-backend
```

#### 2. Install dependencies

```bash
# Activate venv
source venv/bin/activate

# Install project deps
pip install -r requirements.txt
```

#### 3. Database Setup

##### Create PostgreSQL database

```bash
# Connect to PostgreSQL
sudo -u postgres psql

# Create database and user
CREATE DATABASE agentdns;
CREATE USER agentdns WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE agentdns TO agentdns;
\q
```

##### Verify connections

```bash
# Test PostgreSQL
psql -h localhost -U agentdns -d agentdns

# Test Redis
redis-cli ping

# Test Milvus (if using Docker)
docker ps | grep milvus
```

#### 4. Environment Configuration

##### Generate encryption keys

```bash
# Generate keys with helper script
python generate_encryption_key.py
```

##### Configure .env

Create `.env` and set the following keys:

**关键配置项:**
```env
# Database (required)
DATABASE_URL=postgresql://agentdns:your_secure_password@localhost:5432/agentdns
REDIS_URL=redis://localhost:6379

# Security (required - generated by generate_encryption_key.py)
SECRET_KEY=your_generated_SECRET_KEY
ENCRYPTION_KEY=your_generated_ENCRYPTION_KEY

# Milvus
MILVUS_HOST=localhost
MILVUS_PORT=19530

# OpenAI (optional, for semantic search)
OPENAI_API_KEY=your-openai-api-key
```

#### 5. Database Initialization

**Database tables are created automatically on first start**, no manual init needed.

```bash
# Verify DB tables
psql -h localhost -U agentdns -d agentdns -c "\dt"
```

### 🏃‍♂️ Run the Service

#### Development

```bash
# Option 1: run module
python -m app.main

# Option 2: uvicorn (recommended)
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**Tables will be auto-created on the first start**

#### Production

```bash
# Multi-process
uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4

# Or gunicorn
pip install gunicorn
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 👤 Create Admin Account

After the first start, create the admin test account:

```bash
source venv/bin/activate
python scripts/create_admin_user.py

# Default credentials
# Username: admin
# Password: agentdns_666
# Change the password in production
```

### 🧪 Verify Deployment

Check service status with these URLs:

```bash
# Health check
curl http://localhost:8000/health

# API docs
curl -s http://localhost:8000/docs > /dev/null && echo "API Docs available"

# Root path
curl http://localhost:8000/
```

Expected response:
```json
{
  "message": "Welcome to the AgentDNS API",
  "version": "1.0.0",
  "docs": "/docs"
}
```

## 🛠️ 开发指南

### 📁 Project Structure

```
agentdns-backend/
├── app/                    # application
│   ├── api/               # API routes
│   │   ├── client/        # client APIs
│   │   ├── auth.py        # auth
│   │   ├── services.py    # services
│   │   └── ...
│   ├── core/              # core config
│   │   ├── config.py      # configuration
│   │   ├── security.py    # security
│   │   └── ...
│   ├── models/            # ORM models
│   ├── schemas/           # Pydantic schemas
│   ├── services/          # business logic
│   ├── database.py        # DB connection
│   └── main.py           # app entrypoint
├── scripts/               # helper scripts
├── requirements.txt       # dependencies
├── .env.example          # env template
└── README.md             # docs
```

### 🔧 Common Commands

```bash
# Create admin account
python scripts/create_admin_user.py

# Generate encryption keys
python generate_encryption_key.py

# Code formatting
black app/
isort app/

# Run tests
pytest tests/
```

## 🚀 Deployment Guide

### 🔄 systemd service (Linux)

Create service file:
```bash
sudo nano /etc/systemd/system/agentdns.service
```

Service config:
```ini
[Unit]
Description=AgentDNS Backend Service
After=network.target postgresql.service redis.service

[Service]
Type=exec
User=your_username
Group=your_group
WorkingDirectory=/path/to/agentdns-backend
Environment=PATH=/path/to/agentdns-backend/venv/bin
ExecStart=/path/to/agentdns-backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

Enable service:
```bash
sudo systemctl daemon-reload
sudo systemctl enable agentdns
sudo systemctl start agentdns
sudo systemctl status agentdns
```

### 🌐 Nginx reverse proxy

Install Nginx:
```bash
sudo apt install nginx
```

Config (`/etc/nginx/sites-available/agentdns`):
```nginx
server {
    listen 80;
    server_name your_domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Enable config:
```bash
sudo ln -s /etc/nginx/sites-available/agentdns /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 🔍 Troubleshooting

### Common Problems

#### 1. Database connection failure
```bash
# Check PostgreSQL status
sudo systemctl status postgresql

# Check port usage
netstat -tlnp | grep 5432

# Test connection
psql -h localhost -U agentdns -d agentdns
```

#### 2. Redis connection failure
```bash
# Check Redis status
sudo systemctl status redis

# Test connection
redis-cli ping
```

#### 3. Milvus connection failure
```bash
# Check Docker container
docker ps | grep milvus

# View logs
docker-compose logs milvus-standalone
```

#### 4. Dependency installation failure
```bash
# Upgrade pip
python -m pip install --upgrade pip

# Clear cache
pip cache purge

# Install problematic deps individually
pip install psycopg2-binary
pip install pymilvus
```

### Logs

```bash
# systemd service logs
journalctl -u agentdns -f

# Application logs (if configured)
tail -f /var/log/agentdns/app.log

# Nginx access logs
tail -f /var/log/nginx/access.log
```


### Main API endpoints

| Endpoint | Method | Description |
|------|------|------|
| `/api/v1/auth/register` | POST | User registration |
| `/api/v1/auth/token` | POST | User login |
| `/api/v1/services/` | GET | List services |
| `/api/v1/services/` | POST | Create service |
| `/api/v1/discovery/search` | POST | Service discovery |
| `/api/v1/proxy/{path}` | ANY | Service proxy |

## 🤝 Contributing

1. Fork the repo
2. Create a feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit (`git commit -m 'Add some AmazingFeature'`)
4. Push (`git push origin feature/AmazingFeature`)
5. Open a Pull Request

## 📄 License

This project is licensed under MIT.


**AgentDNS** - Make service discovery simple and efficient for AI Agents 🚀